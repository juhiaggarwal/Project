<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Automation Documentation Tool</title>   
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <!-- Google Identity Services -->
  <script  src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Google API Client -->
  <script src="https://apis.google.com/js/api.js"></script>


  <style>
    body {
      background: linear-gradient(to right, #00b5b2d2, #bf1b5ffe);
    }
    
    .dark body {
      background: linear-gradient(to right, #694a4a, #5a5a5a); 
      color: #0c0b0b;
    }
    h1{
      color:#ccc;
    }
    #chatbox { 
      display: none; 
    }
    .action-btn {
            padding: 0.5rem;
            font-size: 0.875rem;
            border-radius: 0.25rem;
            color: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
            }
    .insert-btn { background-color: #214a3b; }
    .delete-btn { background-color: #460505; }
    .upload-btn { background-color: #065014d7; }
     th, td {
      border: 2px solid #333;
    }
    #file-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      margin-top: 10px;
    }

    .file-item {
      padding: 8px;
      cursor: pointer;
      border-bottom: 1px solid #ddd;
    }

    .file-item:hover {
      background-color: #f0f0f0;
    }

    #file-name {
      margin-left: 10px;
      font-weight: bold;
      color: #4CAF50;
    }
    
  .btn-vertical {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 1rem;
    color: #4a5568;
    font-weight: 500;
    text-decoration: none;
    background: transparent;
    border: none;
    cursor: pointer;
    transition: color 0.3s ease;
  }

  .btn-vertical i {
    font-size: 1.6rem; /* Medium icon */
    margin-bottom: 0.25rem;
  }

  .btn-add    { color: #ddf2f2; }   /* teal */
  .btn-preview { color: #e9e8ec; } /* purple */
  .btn-submit { color: #e9eafa; }  /* indigo */
  .btn-export { color: #e1eef1; }  /* cyan */

  .btn-vertical:hover {
    color: #51200f;
    text-decoration: underline;
  }


  
  </style>
</head>
<body class="font-sans">
  <div class="flex min-h-screen">
    <div class="w-64 bg-gray-900 text-white p-4 shadow-lg">
      <h2 class="text-xl font-bold mb-6">Progress Bar:</h2>
      <ul class="space-y-4">
        <li>
          <a href="{{ url_for('register') }}"
             class="block text-gray-200 hover:underline hover:text-teal-300 transition duration-200">
             <i class="fas fa-user-plus mr-2"></i>Register
          </a>
        </li>
        <li>
          <a href="{{ url_for('login') }}"
             class="block text-gray-200 hover:underline hover:text-teal-300 transition duration-200">
             <i class="fas fa-sign-in-alt mr-2"></i>Login
          </a>
        </li>
        <li>
          <a href="/dashboard"
             class="block text-gray-200 hover:underline hover:text-teal-300 transition duration-200">
             <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
          </a>
        </li>
        <li>
          <a href="/generated-files"
             class="block text-gray-200 hover:underline hover:text-teal-300 transition duration-200">
             <i class="fas fa-file-alt mr-2"></i>Report
          </a>
        </li>
        <li>
          <a href="{{ url_for('logout') }}"
             class="block text-gray-200 hover:underline hover:text-teal-300 transition duration-200">
             <i class="fas fa-sign-out-alt mr-2"></i>Logout
          </a>
        </li>
      </ul>
    </div>


    <div class="flex-1 p-8">
      <div class="flex justify-between items-center mb-4">
        <h1 class="text-2xl font-bold text-white">Welcome to Automation Documentation Tool</h1>
        <button onclick="toggleDarkMode()" class="bg-gray-300 dark:bg-gray-700 px-4 py-2 rounded shadow text-sm">üåô</button>
      </div>

      <form id="docForm" enctype="multipart/form-data" method="POST">
        <div id="questions-container" class="space-y-6"></div>
        <div class="mt-6">

          <button type="button" onclick="addNewQuestion()" class="btn-vertical btn-add">
            <i class="fas fa-plus"></i>
            <span>Add New Question</span>
          </button>
          
          <button type="button" onclick="captureAndPreview()" class="btn-vertical btn-preview ml-4">
            <i class="fas fa-eye"></i>
            <span>Preview Document</span>
          </button>
          
          <button type="button" onclick="submitForm()" class="btn-vertical btn-submit ml-4">
            <i class="fas fa-paper-plane"></i>
            <span>Submit Document </span>
          </button>
          
          <button type="button" onclick="exportToPDF()" class="btn-vertical btn-export ml-4">
            <i class="fas fa-file-pdf"></i>
            <span>Export DOCX to PDF</span>
          </button>
          
 

        </div>
      </form>
      
      
      <!-- Assistant Prompt (shown when chatbox is closed) -->
      <!-- Assistant Prompt (Always shown by default) -->
      <div id="assistantPrompt" onclick="toggleChat(true)" class="fixed bottom-4 right-4 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-xl w-64 cursor-pointer flex items-center space-x-2">
      <div style="font-size: 1.5rem;" class="font-bold text-sm text-brown-600">üí¨</div>
      <span class="font-bold text-sm text-blue-600">Hi! Need help? Ask me anything.</span>
      </div>

    <!-- Assistant Chat Box -->
    <div id="chatbox" class="fixed bottom-4 right-4 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-xl w-64 h-64 flex-col justify-between">
    <div class="flex-1 overflow-y-auto" id="chatBox">
    <div><strong>Assistant:</strong> Hi! How can I assist you today?</div>
    </div>
    <div class="mt-2">
    <input type="text" id="chatInput" placeholder="Ask here..."
            class="w-full p-2 text-sm border rounded dark:bg-gray-700 dark:text-white" />
    <div class="flex justify-between mt-1">
      <button onclick="startVoiceInput()" class="text-blue-600">üé§</button>
      <button onclick="sendMessage()" class="text-blue-600">‚û§</button>
    </div>
    </div>
    <button onclick="toggleChat(false)" class="absolute top-2 right-2 text-gray-500">‚ùå</button>
    </div>

    <!-- Assistant Sound -->
    <audio id="assistant-sound" preload="auto">
    <source src="https://www.soundjay.com/buttons/sounds/button-16.mp3" type="audio/mpeg">
    </audio>
      
    

  <div id="upload-modal" class="fixed hidden inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-6 rounded shadow-lg w-96">
      <h3 class="text-lg font-bold mb-4 text-gray-800 dark:text-gray-100">Choose Upload Method</h3>
      <ul class="space-y-4">
        <li class="flex items-center gap-3 cursor-pointer" onclick="handleCameraUpload()">
          <!-- Add this hidden field in your HTML body -->
        <input type="hidden" id="current-upload-row" value="" />

          <i class="fas fa-camera text-pink-600 text-xl"></i><span>Camera</span>
        </li>
        <li class="flex items-center gap-3 cursor-pointer" onclick="handleLocalUpload(this)">
          <i class="fas fa-file-upload text-green-600 text-xl"></i><span>Local Files</span>
        </li>
        
        <li class="flex items-center gap-3 cursor-pointer" onclick="handleDriveUpload()">
          <i class="fab fa-google-drive text-yellow-600 text-xl"></i><span>Google Drive</span>
          <span id="file-name"></span> 
        </li>
        <ul id="file-list" class="mt-4 space-y-2 text-sm text-gray-700"></ul>
      </ul>
      <button onclick="closeUploadModal()" class="mt-4 px-4 py-2 bg-gray-300 rounded shadow">Cancel</button>
    </div>
  </div>  
  <!-- Console log area for displaying errors -->
  <div id="console-output" class="mt-5 bg-gray-800 text-white p-4 rounded"></div>

   

  <script>
    let dark = false;
    let questionCounter = 0;

    if (!window.uploadedFilesData) window.uploadedFilesData = {};



 //--------------------------------DEFAULT QUESTIONS------------------------------
    const defaultQuestions = [
      "What is automation documentation?",
      "Why is it important in software processes?",
      "List the tools used in automation.",
      "Describe test case automation steps.",
      "What are benefits of automation?",
      "List challenges in automation documentation."
    ];
  
 
//-----------------DARK MODE-----------------------
    function toggleDarkMode() {
      dark = !dark;
      document.documentElement.classList.toggle('dark', dark);
    }

//-----------------------CHAT-------------------
    function toggleChat(open) {
      const chatbox = document.getElementById('chatbox');
      const prompt = document.getElementById('assistantPrompt');
      const sound = document.getElementById('assistant-sound');

      if (open) {
        chatbox.style.display = 'flex';
        prompt.style.display = 'none';
        sound.play().catch(err => console.warn("Autoplay blocked:", err));
      } else {
        chatbox.style.display = 'none';
        prompt.style.display = 'flex';
      }
    }

    function startVoiceInput() {
      if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        alert("Speech Recognition not supported.");
        return;
      }
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      recognition.lang = 'en-US';
      recognition.start();
      recognition.onresult = function (e) {
        document.getElementById("chatInput").value = e.results[0][0].transcript;
      };
      recognition.onerror = function (e) {
        alert("Error: " + e.error);
      };
    }

    function sendMessage() {
      const input = document.getElementById("chatInput");
      const message = input.value.trim();
      if (!message) return;

      const box = document.getElementById("chatBox");
      box.innerHTML += `<div><strong>You:</strong> ${message}</div>`;

      fetch("/chat", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query: message })
      })
      .then(res => res.json())
      .then(data => {
        const reply = data.response || data.error || "‚ö†Ô∏è No response.";
        box.innerHTML += `<div><strong>Assistant:</strong> ${reply}</div>`;
        box.scrollTop = box.scrollHeight;
      })
      .catch(err => {
        box.innerHTML += `<div><strong>Assistant:</strong> ‚ö†Ô∏è ${err.message}</div>`;
      });

      input.value = "";
    }

    document.getElementById("chatInput").addEventListener("keypress", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
      }
    });

//--------------------------NEW QUESTION------------------------
    function addNewQuestion(text = '') {
    const container = document.getElementById("questions-container");
    const id = `q-${Date.now()}-${questionCounter++}`;  // Unique qid for each question
    const questionHTML = `
      <div id="${id}-block" class="question-block border p-4 bg-white dark:bg-gray-700 rounded shadow mt-4">
        <input type="hidden" class="qid" value="${id}">  <!-- Add hidden qid field -->
        <label class="font-semibold text-gray-700 dark:text-gray-200">Question:</label>
        <input name="question_text_${id}" type="text" class="w-full mt-2 p-2 border rounded" value="${text}" placeholder="Enter your question here...">
        <label class="block mt-4 text-sm">Select your response type:</label>
        <select class="w-full p-2 mt-1 border rounded" onchange="handleResponseType(this, '${id}')">
          <option value="default">Default</option>
          <option value="text">üìù Text</option>
          <option value="table">üìä Table</option>
          <option value="skip">üö´ Skip</option>
        </select>
        <div id="response-area-${id}" class="mt-4"></div>
      </div>
    `;
    container.insertAdjacentHTML('beforeend', questionHTML);
  }

    
  //--------------------RESONSE TYPE------------------------------
    function handleResponseType(selectEl, id) {
      const area = document.getElementById(`response-area-${id}`);
      area.innerHTML = ''; // Clear previous response content
  
      if (selectEl.value === 'text') {
        area.innerHTML = `
          <textarea class='w-full h-24 p-2 border rounded' placeholder='Enter your response'></textarea>
        `;
      } 
     
      else if (selectEl.value === 'table') {
        const rows = parseInt(prompt("Enter number of rows:"));
        const cols = parseInt(prompt("Enter number of columns:"));
        if (isNaN(rows) || isNaN(cols)) {
          alert("Invalid input.");
          return;
        }
        area.innerHTML += `<input type="hidden" name="question_type_${id}" value="table:${rows}x${cols}">`;
  
        const headings = [];
        for (let i = 0; i < cols; i++) {
          const heading = prompt(`Enter heading for column ${i + 1}`) || `Column ${i + 1}`;
          headings.push(heading);
        }
  
        let tableHTML = `<table class='w-full border mt-2'><thead><tr>`;
        headings.forEach(h => {
          tableHTML += `<th class='border p-1 font-bold'>${h}</th>`;
        });
        tableHTML += `<th class='font-bold'>Actions</th></tr></thead><tbody>`;
  
          for (let i = 0; i < rows; i++) {
                const rowId = `upload-name-${id}-${i}-${Date.now()}`;
                tableHTML += `<tr>`;
                for (let j = 0; j < cols; j++) {
                  tableHTML += `<td class='border p-1'><input name="cell_${id}_r${i}_c${j}" class='w-full p-1 border' type='text'></td>`;
                }
                tableHTML += `
                  <td class='flex space-x-2 p-1'>
                    <button type="button" class='action-btn insert-btn' onclick="handleInsertRow(this, '${id}', ${cols})">Insert</button>
                    <button type="button" class='action-btn delete-btn' onclick="this.closest('tr').remove()">Delete</button>
                    <button type="button" class='action-btn upload-btn' onclick="openUploadModal('upload-name-${id}-${i}-${cols}')">Upload</button>
                    <span id="upload-name-${id}-${i}-${cols}" class="text-sm ml-2 text-green-600"></span>
                  </td>
                </tr>`;
              }
    
        
  
        tableHTML += `</tbody></table>`;
        area.innerHTML = tableHTML;
  
      } else if (selectEl.value === 'skip') {
        area.innerHTML = `<p class='text-gray-500 italic'>This question is skipped.</p>`;
      }
    }


  //--------------------------------INSERTROW---------------------------
    function handleInsertRow(button, id, colCount) {
      const currentRow = button.closest('tr');
      const table = currentRow.closest('table');
      const tbody = table.querySelector('tbody');
      const newRow = document.createElement('tr');
  
      for (let i = 0; i < colCount; i++) {
        newRow.innerHTML += `<td class='border p-1'><input class='w-full p-1 border' type='text'></td>`;
      }
  
      const rowId = `upload-name-${id}-${Date.now()}`;
      newRow.innerHTML += `
        <td class='flex space-x-2 p-1'>
          <button type="button" class='action-btn insert-btn' onclick="handleInsertRow(this, '${id}', ${colCount})">Insert</button>
          <button type="button" class='action-btn delete-btn' onclick="this.closest('tr').remove()">Delete</button>
          <button type="button" class='action-btn upload-btn' onclick="openUploadModal('${rowId}')">Upload</button>
          <span id="${rowId}" class="text-sm ml-2 text-green-600"></span>
        </td>
      `;
  
      const position = prompt("Insert row 'above' or 'below'?").toLowerCase();
      if (position === 'above') {
        tbody.insertBefore(newRow, currentRow);
      } else if (position === 'below') {
        tbody.insertBefore(newRow, currentRow.nextSibling);
      } else {
        alert("Invalid input. Type 'above' or 'below'.");
      }
    }
  


//------------------------- PREVIEW-------------------------------------------------------------------
function captureAndPreview() {
  const questionBlocks = document.querySelectorAll('.question-block');

  // Helper to extract clean filename
  function getCleanFileName(filePath) {
    return filePath.split('\\').pop().split('/').pop();
  }

  let documentHTML = `
    <html>
      <head><title>Document Preview</title></head>
      <style>
        table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 20px;
        }
        th, td {
          border: 1px solid #333;
          padding: 8px;
          text-align: left;
        }
        th {
          background-color: #f5f5f5;
        }
      </style>
      <body style='font-family:sans-serif; padding:20px;'>
        <h1 style='text-align:center; color:#214a3b;'>Automation Generation Tool</h1>
  `;

  questionBlocks.forEach(block => {
    const question = block.querySelector("input[type='text']").value;
    const select = block.querySelector("select").value;
    const responseArea = block.querySelector("[id^='response-area']");
    const questionSkippedMessage = "Skipped";

    if (!question) {
      documentHTML += `<h3>${questionSkippedMessage}</h3>`;
      return;
    }

    documentHTML += `<h3>${question}</h3>`;

    if (select === 'text') {
      const text = responseArea.querySelector("textarea")?.value || '';
      documentHTML += text.trim()
        ? `<pre style='white-space:pre-wrap;'>${text}</pre>`
        : `<p>${questionSkippedMessage}: No response provided.</p>`;
    } else if (select === 'table') {
      const table = block.querySelector('table');
      if (table) {
        const clonedTable = table.cloneNode(true);
        clonedTable.querySelectorAll("tbody tr").forEach(row => {
          row.querySelectorAll("td").forEach((cell, colIndex) => {
            const input = cell.querySelector("input");
            if (input) {
              let value = input.value.trim();
              if (input.type === 'file') {
                const files = input.files;
                if (files.length > 0) {
                  const file = files[0];
                  const fileURL = URL.createObjectURL(file);
                  const fileName = file.name;
                  cell.innerHTML = `<a href="${fileURL}" download="${fileName}">${fileName}</a>`;
                } else {
                  cell.textContent = 'No file selected';
                }
              } else {
                cell.textContent = value || "\u00A0";
              }
            }
            const span = cell.querySelector("span");
            if (span && span.id) {
              const match = span.id.match(/upload-name-(.+)-(\d+)-(\d+)/);
              if (match) {
                const [_, qid, rowIndex, colIndex] = match;
                const key = `${qid}-${rowIndex}-${colIndex}`;
                const uploadedFile = window.uploadedFilesData?.[key];
                if (uploadedFile) {
                  const fileURL = URL.createObjectURL(uploadedFile.file);
                  const fileName = uploadedFile.name;
                  cell.innerHTML = `<a href="${fileURL}" download="${fileName}">${fileName}</a>`;
                } else {
                  cell.textContent = 'No file uploaded';
                }
              }
            }
          });
        });
        documentHTML += `<h3>Response Table</h3>${clonedTable.outerHTML}`;
      } else {
        documentHTML += `<p>${questionSkippedMessage}: No table provided.</p>`;
      }
    } else if (select === 'skip') {
      documentHTML += `<p>${questionSkippedMessage}: User skipped this question.</p>`;
    } else {
      documentHTML += `<p>${questionSkippedMessage}: No response type selected.</p>`;
    }
  });

  documentHTML += '</body></html>';
  const previewWindow = window.open('', '_blank');
  previewWindow.document.write(documentHTML);
  previewWindow.document.close();
}

/*
function captureAndPreview() {
  const questionBlocks = document.querySelectorAll('.question-block');

  // Helper to extract clean filename
  function getCleanFileName(filePath) {
    return filePath.split('\\').pop().split('/').pop();
  }

  let documentHTML = `
    <html>
      <head><title>Document Preview</title></head>
      <style>
        table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 20px;
        }
        th, td {
          border: 1px solid #333;
          padding: 8px;
          text-align: left;
        }
        th {
          background-color: #f5f5f5;
        }
      </style>
      <body style='font-family:sans-serif; padding:20px;'>
        <h1 style='text-align:center; color:#214a3b;'>Automation Generation Tool</h1>
  `;

  questionBlocks.forEach(block => {
    const question = block.querySelector("input[type='text']").value;
    const select = block.querySelector("select").value;
    const responseArea = block.querySelector("[id^='response-area']");
    const questionSkippedMessage = "Skipped";

    if (!question) {
      documentHTML += `<h3>${questionSkippedMessage}</h3>`;
      return;
    }

    documentHTML += `<h3>${question}</h3>`;

    if (select === 'text') {
      const text = responseArea.querySelector("textarea")?.value || '';
      documentHTML += text.trim()
        ? `<pre style='white-space:pre-wrap;'>${text}</pre>`
        : `<p>${questionSkippedMessage}: No response provided.</p>`;
    } else if (select === 'table') {
      const table = block.querySelector('table');
      if (table) {
        const clonedTable = table.cloneNode(true);
        clonedTable.querySelectorAll("tbody tr").forEach(row => {
          row.querySelectorAll("td").forEach((cell, colIndex) => {
            const input = cell.querySelector("input");
            if (input) {
              let value = input.value.trim();
              if (input.type === 'file') {
                value = getCleanFileName(value);
              }
              cell.textContent = value || "\u00A0";
            }

            const span = cell.querySelector("span");
            if (span && span.id) {
              const match = span.id.match(/upload-name-(.+)-(\d+)-(\d+)/);
              if (match) {
                const [_, qid, rowIndex, colIndex] = match;
                const key = `${qid}_${rowIndex}_${colIndex}`;
                const uploadedFile = window.uploadedFilesData[key];
                if (uploadedFile) {
                  const fileURL = URL.createObjectURL(uploadedFile.file);
                  const fileName = uploadedFile.name;
                  cell.innerHTML = `<a href="${fileURL}" download="${fileName}">${fileName}</a>`;
                } else {
                  cell.textContent = '';
                }
              }
            }
          });
        });
        documentHTML += `<h3>Response Table</h3>${clonedTable.outerHTML}`;
      } else {
        documentHTML += `<p>${questionSkippedMessage}: No table provided.</p>`;
      }
    } else {
      documentHTML += `<p>${questionSkippedMessage}: No response type selected.</p>`;
    }
  });

  documentHTML += '</body></html>';
  const previewWindow = window.open('', '_blank');
  previewWindow.document.write(documentHTML);
  previewWindow.document.close();
}

*/


//------------------------BLOB----------------------------------------
function dataURLtoBlob(dataURL) {
  const byteString = atob(dataURL.split(',')[1]);
     const mimeString = dataURL.split(',')[0].split(':')[1].split(';')[0];
  const ab = new ArrayBuffer(byteString.length);
  const ia = new Uint8Array(ab);
  for (let i = 0; i < byteString.length; i++) {
    ia[i] = byteString.charCodeAt(i);
  }
  return new Blob([ab], { type: mimeString });
}


//---------------------- submit form------------------------------
async function submitForm() {
    const filename = prompt("Enter filename:");
    const username = prompt("Enter your name:");
    if (!filename || !username) {
        alert("Filename and username are required.");
        return;
    }

    const formData = new FormData();
    formData.append("filename", filename);
    formData.append("username", username);

    console.log("üìÇ Starting form submission with filename:", filename, "and username:", username);

    const blocks = document.querySelectorAll(".question-block");
    if (blocks.length === 0) {
        alert("No questions found.");
        console.error("‚ùå No question blocks found in the DOM.");
        return;
    }

    blocks.forEach((block, blockIndex) => {
        const qid = block.querySelector(".qid").value;
        const questionText = block.querySelector("input[type='text']").value.trim();
        const responseType = block.querySelector("select").value;

        console.log(`üîπ Processing question block ${blockIndex} (QID: ${qid}), Type: ${responseType}`);

        formData.append(`${qid}_question`, questionText);
        formData.append(`${qid}_type`, responseType);

        if (responseType === 'text') {
            const response = block.querySelector("textarea")?.value.trim() || "No response provided.";
            console.log(`‚úèÔ∏è Text response for QID ${qid}:`, response);
            formData.append(`${qid}_response`, response);
        } else if (responseType === 'table') {
            const table = block.querySelector("table");
            if (table) {
                const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.textContent);
                console.log(`üóÇ Table headers for QID ${qid}:`, headers);
                formData.append(`${qid}_table_headers`, JSON.stringify(headers));

                table.querySelectorAll("tbody tr").forEach((row, rowIndex) => {
                    row.querySelectorAll("td").forEach((cell, colIndex) => {
                        const input = cell.querySelector("input[type='text']");
                        if (input) {
                            const value = input.value.trim();
                            console.log(`üìÑ QID ${qid}, Row ${rowIndex}, Col ${colIndex} - Cell Text:`, value);
                            formData.append(`${qid}_r${rowIndex}_c${colIndex}`, value);
                        }
                        

                        const fileKey = `${qid}-${rowIndex}-${colIndex}`;
                        const spanId = `upload-name-${qid}-${rowIndex}-${colIndex}`;
                        const span = cell.querySelector(`span#${spanId}`);

                        if (window.uploadedFilesData[fileKey]) {
                            const { file, name } = window.uploadedFilesData[fileKey];
                            formData.append(`${qid}_r${rowIndex}_c${colIndex}_file`, file, name);
                            formData.append(`${qid}_r${rowIndex}_c${colIndex}_filename`, name);
                            const fileURL = URL.createObjectURL(file);
                            console.log(`üìÇ Found uploaded file for ${fileKey}:`, name);

                            if (span) {
                                span.innerHTML = `<a href="${fileURL}" download="${name}">${name}</a>`;
                                console.log(`‚úÖ Updated span ${spanId} with file link.`);
                                span.style.color = 'green';
                            } else {
                                console.error(`‚ùå Span with id ${spanId} not found for fileKey ${fileKey}`);
                                console.warn(`üö® Possible mismatch between span ID and fileKey. Check HTML table generation.`);
                                alert(`Error: File "${name}" uploaded for QID ${qid}, row ${rowIndex}, col ${colIndex}, but action cell span was not found.`);
                            }
                        } else {
                            console.warn(`‚ö†Ô∏è No uploaded file found for fileKey ${fileKey}.`);
                            if (span) {
                                span.textContent = 'No file uploaded';
                                span.style.color = 'red';
                            } else {
                                console.warn(`‚ö†Ô∏è No span found for fileKey ${fileKey}.`);
                            }
                        }
                    });
                });
            } else {
                console.warn(`‚ùå No table found for QID ${qid}.`);
                formData.append(`${qid}_response`, "No table provided.");
            }
        } else if (responseType === 'skip') {
            console.log(`üö´ QID ${qid} marked as skipped by user.`);
            formData.append(`${qid}_response`, "Skipped by user.");
        } else {
            console.warn(`‚ö†Ô∏è QID ${qid} has an unknown or no response type.`);
            formData.append(`${qid}_response`, "No response selected.");
        }
    });

    console.log("üì§ Final FormData keys:");
    for (let pair of formData.entries()) {
        console.log(pair[0], ':', pair[1]);
    }

    try {
        const res = await fetch('/submit', { method: 'POST', body: formData });
        const data = await res.json();
        console.log("üì¨ Server response:", data);

        if (data.success) {
            alert('Documents generated Succesfully! To convert your responses to PDF format Click on Export to Pdf');
            window.open(data.response_doc_url, '_blank');
            window.open(data.upload_doc_url, '_blank');
        } else {
            console.error('‚ùå Server reported an error:', data.message);
            alert(data.message);
        }
    } catch (err) {
        console.error("üö® Submission failed with error:", err);
        alert("Submission failed. Check the console for errors.");
    }
}


// ---------------------------pdf maker----------------------------------------

           
    
function exportToPDF() {
    const filename = prompt("Enter the base filename you used during submission:");
    if (!filename) return;

    fetch(`/export-pdf?filename=${encodeURIComponent(filename)}`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
              alert('PDF of your responses generated successfully!');
                // Download response PDF
                const a1 = document.createElement("a");
                a1.href = data.response_pdf_url;
                a1.download = `${filename}_response.pdf`;
                document.body.appendChild(a1);
                a1.click();
                a1.remove();

                // Download uploads PDF
                const a2 = document.createElement("a");
                a2.href = data.uploads_pdf_url;
                a2.download = `${filename}_uploads.pdf`;
                document.body.appendChild(a2);
                a2.click();
                a2.remove();
            } else {
                alert("PDF export failed: " + data.message);
            }
        })
        .catch(err => {
            alert("Request failed: " + err.message);
        });
}





//HELPER
function parseRowSpanId(rowSpanId) {
  const prefix = "upload-name-";
  if (!rowSpanId.startsWith(prefix)) {
    alert("‚ùå Invalid rowSpanId format.");
    return null;
  }

  const idParts = rowSpanId.replace(prefix, "").split("-");
  if (idParts.length < 3) {
    alert("‚ùå Not enough parts in rowSpanId.");
    return null;
  }

  const colIndex = idParts.pop();
  const rowIndex = idParts.pop();
  const qid = idParts.join("-");

  return { qid, rowIndex, colIndex };
}






//-------CAMERA-----------

function handleCameraUpload() {
  closeUploadModal();
  const rowSpanId = document.getElementById("current-upload-row").value;

  // ‚úÖ Proper parsing of rowSpanId
  const prefix = "upload-name-";
  if (!rowSpanId.startsWith(prefix)) return alert("‚ùå Invalid row identifier.");

  const parts = rowSpanId.replace(prefix, "").split("-");
  if (parts.length < 3) return alert("‚ùå Incomplete row identifier.");

  const colIndex = parts.pop();
  const rowIndex = parts.pop();
  const qid = parts.join("-");

  const modal = document.createElement('div');
  modal.style = `position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999;`;

  const container = document.createElement('div');
  container.style = `background:#fff;padding:20px;border-radius:8px;text-align:center;`;

  const video = document.createElement('video');
  video.autoplay = true;
  video.width = 320;
  video.height = 240;

  const captureBtn = document.createElement('button');
  captureBtn.textContent = 'Capture';
  captureBtn.style = 'margin-top:10px;';

  const cancelBtn = document.createElement('button');
  cancelBtn.textContent = 'Cancel';
  cancelBtn.style = 'margin-top:10px;margin-left:10px;';

  container.appendChild(video);
  container.appendChild(captureBtn);
  container.appendChild(cancelBtn);
  modal.appendChild(container);
  document.body.appendChild(modal);

  navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
    video.srcObject = stream;

    const stopStream = () => {
      stream.getTracks().forEach(track => track.stop());
    };

    captureBtn.onclick = () => {
      captureBtn.disabled = true;
      cancelBtn.disabled = true;

      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth || 320;
      canvas.height = video.videoHeight || 240;
      canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(blob => {
        // const timestamp = Date.now();
        const capturedFile = new File([blob], `camera_capture.png`, { type: "image/png" });

        const fileKey = `${qid}-${rowIndex}-${colIndex}`; // ‚úÖ Correct: 3-part key
        window.uploadedFilesData[fileKey] = {
          file: capturedFile,
          name: capturedFile.name,
          source: 'camera'
        };

        console.log("üì∏ Saved camera file to uploadedFilesData:", fileKey, window.uploadedFilesData[fileKey]);

        const span = document.getElementById(rowSpanId);
        if (span) {
          const fileURL = URL.createObjectURL(capturedFile);
          span.innerHTML = `<a href="${fileURL}" download="${capturedFile.name}">${capturedFile.name}</a>`;
          span.style.color = 'green';
          alert(`üì∏ Camera image "${capturedFile.name}" captured successfully!`);
        }

        stopStream();
        document.body.removeChild(modal);
      }, "image/png");
    };

    cancelBtn.onclick = () => {
      stopStream();
      document.body.removeChild(modal);
    };
  }).catch(err => {
    alert("Camera access failed: " + err.message);
    document.body.removeChild(modal);
  });
}

     
 

//------OPENUPLOADMODAL--------------------

 
  

function openUploadModal(rowSpanId) {
  document.getElementById("current-upload-row").value = rowSpanId;
  document.getElementById("upload-modal").classList.remove("hidden");
}
  
//--------------CLOSEUPLOADMODAL----------------

function closeUploadModal() {
          document.getElementById("upload-modal").classList.add("hidden");
          const modal = document.getElementById('filePickerModal');
                if (modal) modal.style.display = 'none';
                
                // Optional: clear the file list for next time
                const listEl = document.getElementById('file-list');
                if (listEl) listEl.innerHTML = '';
        }

//---------HANDLE LOCAL--------------------
function handleLocalUpload() {
  const rowSpanId = document.getElementById("current-upload-row").value;
  const [_, qid, rowIndex, colIndex] = rowSpanId.match(/upload-name-(.+)-(\d+)-(\d+)/) || [];
  if (!qid || rowIndex === undefined || colIndex === undefined) return alert("Invalid row identifier.");

  

  closeUploadModal();
  const span = document.getElementById(rowSpanId);
  const parentCell = span.closest("td");

  const input = document.createElement("input");
  input.type = "file";
  input.style.display = "none";

  input.onchange = () => {
  if (input.files.length) {
    const file = input.files[0];
    window.uploadedFilesData[`${qid}-${rowIndex}-${colIndex}`] = { file, name: file.name, source: 'local' };
    const fileURL = URL.createObjectURL(file);
    span.innerHTML = `<a href="${fileURL}" download="${file.name}">${file.name}</a>`;
    span.style.color = 'green';
    alert(`‚úÖ Local file "${file.name}" selected successfully!`);
  }
};

  parentCell.appendChild(input);
  input.click();
}

  


//------------------------DRIVE----------------
const CLIENT_ID = '779432550142-f7rcfe84bkleekbhqu0h25lcgnd8015s.apps.googleusercontent.com';
const API_KEY = 'AIzaSyCBCREN-_X4McuGHQHdGBfDSCBI-hwYNDI';
const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';

let tokenClient;

function handleDriveUpload() {

  const rowSpanId = document.getElementById("current-upload-row").value;
  const [_, qid, rowIndex, colIndex] = rowSpanId.match(/upload-name-(.+)-(\d+)-(\d+)/) || [];

  if (!qid || rowIndex === undefined || colIndex === undefined) {
    return alert("Invalid row identifier.");
}


  gapi.load('client', async () => {
    await gapi.client.init({
      apiKey: API_KEY,
      discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
    });
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: (tokenResponse) => {
        if (tokenResponse.error) return alert("Authorization error");
        gapi.client.setToken(tokenResponse);
        listDriveFiles(qid, rowIndex, colIndex, rowSpanId);  // Pass colIndex and rowSpanId as well
      }
    });
    tokenClient.requestAccessToken();
  });
}

function listDriveFiles(qid, rowIndex, colIndex, rowSpanId) {
  gapi.client.drive.files.list({
    pageSize: 50,
    fields: 'files(id,name,mimeType)',
    q: 'trashed=false'
  }).then(response => {
    const files = response.result.files;
    const listEl = document.getElementById('file-list');
    listEl.innerHTML = '';
    if (!files.length) return listEl.innerHTML = '<li>No files found.</li>';

    files.forEach(file => {
      const li = document.createElement('li');
      li.textContent = `${file.name} (${file.mimeType})`;
      li.className = 'cursor-pointer px-2 py-1 hover:bg-blue-100 rounded';

      li.onclick = async () => {
        try {
          const accessToken = gapi.client.getToken().access_token;
          const res = await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`, {
            headers: { Authorization: `Bearer ${accessToken}` }
          });
          if (!res.ok) throw new Error("Failed to download");
          const blob = await res.blob();

          const fileObj = new File([blob], file.name, { type: blob.type });

          window.uploadedFilesData[`${qid}-${rowIndex}-${colIndex}`] = {
            file: fileObj,
            name: file.name,
            source: 'drive'
          };

          const span = document.getElementById(rowSpanId);
          if (span) {
              const fileURL = URL.createObjectURL(fileObj);  // Correctly create URL from Blob
              span.innerHTML = `<a href="${fileURL}" download="${file.name}">${file.name}</a>`;
              span.style.color = 'green';
              alert(`üåê Google Drive file "${file.name}" selected successfully!`);
          }


          closeUploadModal();
        } catch (err) {
          alert("Drive error: " + err.message);
        }
      };

      listEl.appendChild(li);
    });
  }).catch(err => alert("Drive listing error: " + err.message));
}



  
   
    defaultQuestions.forEach(q => addNewQuestion(q));
  </script>
</body>
</html>










